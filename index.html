<!DOCTYPE html>

<html lang="en">

<head>

    <meta charset="utf-8" />

    <meta content="width=device-width, initial-scale=1.0" name="viewport" />

    <title>Mental Health Recording - Dark Mode Plant State</title>

    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>

    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;700&amp;display=swap" rel="stylesheet" />

    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap"
        rel="stylesheet" />

    <script id="tailwind-config">

        tailwind.config = {

            darkMode: "class",

            theme: {

                extend: {

                    colors: {

                        "primary": "#19e619",

                        "background-light": "#f6f8f6",

                        "background-dark": "#112111", "background-navy": "#0f172a", "text-main": "#111811",

                        "surface-light": "#ffffff",

                    },

                    fontFamily: {

                        "display": ["Manrope", "sans-serif"]

                    },

                    borderRadius: {

                        "DEFAULT": "1rem",

                        "lg": "2rem",

                        "xl": "3rem",

                        "full": "9999px"

                    },

                },

            },

        }

    </script>

    <style>
        .no-scrollbar::-webkit-scrollbar {

            display: none;

        }

        .no-scrollbar {

            -ms-overflow-style: none;

            scrollbar-width: none;

        }

        @keyframes wave {

            0%,
            100% {
                height: 10%;
            }

            50% {
                height: 100%;
            }

        }

        .wave-bar {

            animation: wave 1s ease-in-out infinite;

        }

        .wave-bar:nth-child(1) {
            animation-duration: 0.8s;
        }

        .wave-bar:nth-child(2) {
            animation-duration: 1.1s;
        }

        .wave-bar:nth-child(3) {
            animation-duration: 0.9s;
        }

        .wave-bar:nth-child(4) {
            animation-duration: 1.2s;
        }

        .wave-bar:nth-child(5) {
            animation-duration: 0.7s;
        }

        .wave-bar:nth-child(6) {
            animation-duration: 1.0s;
        }

        .wave-bar:nth-child(7) {
            animation-duration: 0.8s;
        }

        .wave-bar:nth-child(8) {
            animation-duration: 1.3s;
        }

        .wave-bar:nth-child(9) {
            animation-duration: 0.9s;
        }

        .wave-bar:nth-child(10) {
            animation-duration: 1.1s;
        }

        /* Custom Wave Animation */
        @keyframes wave {

            0%,
            100% {
                height: 4px;
                opacity: 0.5;
            }

            50% {
                height: 24px;
                opacity: 1;
            }
        }

        /* The "Apple" Spring Physics Curve */
        .spring-transition {
            transition: all 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        @keyframes grow {

            0% {
                transform: scale(0.95);
            }

            50% {
                transform: scale(1.05);
            }

            100% {
                transform: scale(0.95);
            }

        }

        .plant-grow {

            animation: grow 4s ease-in-out infinite;

        }
    </style>

    <style>
        body {

            min-height: max(884px, 100dvh);

        }
    </style>

    <style>
        body {

            min-height: max(884px, 100dvh);

        }
    </style>

</head>

<body
    class="bg-background-navy font-display min-h-screen flex flex-col items-center justify-center relative overflow-hidden">

    <div class="relative w-full max-w-md h-full min-h-screen flex flex-col bg-background-navy overflow-hidden">

        <div class="flex-1 flex flex-col items-center justify-center pb-32 relative">

            <div class="relative w-64 h-64 flex items-end justify-center plant-grow">

                <div
                    class="w-32 h-28 bg-[#2d3748] rounded-b-3xl rounded-t-lg relative z-10 shadow-2xl border border-white/5">

                    <div class="absolute top-0 left-0 right-0 h-4 bg-[#4a5568] rounded-t-lg opacity-50"></div>

                </div>

                <div
                    class="absolute bottom-24 w-2 h-32 bg-green-700/80 rounded-full z-0 origin-bottom transform -translate-x-1">
                </div>

                <div
                    class="absolute bottom-36 left-12 w-20 h-20 bg-green-500 rounded-tr-[4rem] rounded-bl-[4rem] transform -rotate-45 shadow-lg opacity-90">
                </div>

                <div
                    class="absolute bottom-36 left-12 w-20 h-20 bg-green-400/20 rounded-tr-[4rem] rounded-bl-[4rem] transform -rotate-45 scale-90">
                </div>

                <div
                    class="absolute bottom-40 right-10 w-24 h-24 bg-green-400 rounded-tl-[4rem] rounded-br-[4rem] transform rotate-45 shadow-lg">
                </div>

                <div
                    class="absolute bottom-56 w-16 h-16 bg-primary rounded-tr-[3rem] rounded-bl-[3rem] transform -rotate-12 shadow-[0_0_20px_rgba(25,230,25,0.4)]">
                </div>

                <div
                    class="absolute bottom-20 left-1/2 -translate-x-1/2 w-48 h-48 bg-primary/20 blur-[60px] rounded-full -z-10">
                </div>

            </div>

        </div>

        <div class="fixed bottom-8 left-1/2 -translate-x-1/2 z-50 flex flex-col items-center">

            <div id="status-text"
                class="mb-4 text-center opacity-0 transition-opacity duration-300 pointer-events-none">
                <p class="text-white/80 text-lg font-medium tracking-wide">Listening...</p>
            </div>

            <div id="dynamic-island"
                class="relative bg-[#1a2c1a] shadow-[0_8px_32px_rgba(0,0,0,0.5)] border border-white/10 overflow-hidden transition-all duration-500 ease-[cubic-bezier(0.32,0.72,0,1)] w-16 h-16 rounded-[32px]">

                <div id="state-idle"
                    class="absolute inset-0 flex items-center justify-center transition-opacity duration-300 opacity-100">
                    <button id="btn-record"
                        class="w-full h-full flex items-center justify-center text-primary hover:text-white transition-colors">
                        <span class="material-symbols-outlined text-[32px]">mic</span>
                    </button>
                </div>

                <div id="state-recording"
                    class="absolute inset-0 flex items-center justify-between px-1 opacity-0 transition-opacity duration-300 pointer-events-none">

                    <button id="btn-cancel"
                        class="w-12 h-12 flex items-center justify-center rounded-full text-white/50 hover:bg-white/10 hover:text-white transition-all">
                        <span class="material-symbols-outlined text-[20px]">close</span>
                    </button>

                    <div class="flex items-center gap-[3px] h-8 mx-2">
                        <div class="w-1 bg-primary rounded-full animate-[wave_1s_ease-in-out_infinite]"></div>
                        <div class="w-1 bg-primary rounded-full animate-[wave_1.2s_ease-in-out_infinite]"></div>
                        <div class="w-1 bg-primary rounded-full animate-[wave_0.8s_ease-in-out_infinite]"></div>
                        <div class="w-1 bg-primary rounded-full animate-[wave_1.1s_ease-in-out_infinite]"></div>
                    </div>

                    <button id="btn-stop"
                        class="w-12 h-12 flex items-center justify-center rounded-full bg-primary hover:bg-green-400 text-background-navy shadow-lg transition-transform active:scale-90">
                        <div class="w-4 h-4 bg-background-navy rounded-[2px]"></div>
                    </button>
                </div>

            </div>
        </div>


        <script>
    // --- CONFIGURATION ---
    // ðŸ”´ PASTE YOUR COLAB URL HERE (Don't forget the /predict at the end)
    const API_URL = "http://127.0.0.1:8001/predict"; 

    // --- UI ELEMENTS ---
    const island = document.getElementById('dynamic-island');
    const stateIdle = document.getElementById('state-idle');
    const stateRec = document.getElementById('state-recording');
    const statusText = document.querySelector('#status-text p'); // Select the paragraph inside

    const btnRecord = document.getElementById('btn-record');
    const btnStop = document.getElementById('btn-stop');
    const btnCancel = document.getElementById('btn-cancel');

    // --- AUDIO VARIABLES ---
    let mediaRecorder;
    let audioChunks = [];

    // --- 1. ANIMATION: EXPAND (Start Listening) ---
    function openIsland() {
        // Expand
        island.style.width = '240px'; 
        island.style.height = '64px';
        island.style.borderRadius = '32px';

        // Switch States
        stateIdle.style.opacity = '0';
        stateIdle.style.pointerEvents = 'none';
        
        setTimeout(() => {
            stateRec.style.opacity = '1';
            stateRec.style.pointerEvents = 'auto';
            statusText.innerText = "Listening...";
            statusText.parentElement.style.opacity = '1';
        }, 200);
    }

    // --- 2. ANIMATION: COLLAPSE (Reset) ---
    function closeIsland() {
        stateRec.style.opacity = '0';
        stateRec.style.pointerEvents = 'none';
        statusText.parentElement.style.opacity = '0';

        setTimeout(() => {
            island.style.width = '64px';
            island.style.height = '64px';
            island.style.borderRadius = '32px';
            
            stateIdle.style.opacity = '1';
            stateIdle.style.pointerEvents = 'auto';
            // Reset text for next time
            setTimeout(() => statusText.innerText = "Listening...", 300);
        }, 100);
    }

    // --- 3. CORE: RECORDING ---
    async function startRecording(e) {
        
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            audioChunks = [];

            mediaRecorder.ondataavailable = e => audioChunks.push(e.data);

            mediaRecorder.onstop = async () => {
                // Create the audio file
                const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                
                // Send it to the AI
                sendToBrain(audioBlob);
            };

            mediaRecorder.start();
            openIsland();

        } catch (err) {
            console.error("Mic Error:", err);
            alert("Please allow microphone access to talk to the plant!");
        }
        e.preventDefault();
    }

    function stopRecording() {
        if (mediaRecorder && mediaRecorder.state !== "inactive") {
            mediaRecorder.stop();
            // Update UI immediately to show we are working
            statusText.innerText = "Thinking...";
        }
    }

    // --- 4. THE BRIDGE: SEND TO COLAB ---
    // --- 4. THE BRIDGE: SEND TO BRAIN (Debug Version) ---
    async function sendToBrain(blob) {
        const formData = new FormData();
        formData.append("file", blob, "voice_input.wav");

        try {
            statusText.innerText = "Sending to Brain..."; // Status Update
            
            const response = await fetch(API_URL, {
                method: "POST",
                body: formData
            });

            const data = await response.json();
            console.log("AI Raw Data:", data); 

            // ðŸš¨ IF PYTHON SENT AN ERROR
            if (data.error) {
                // Show the ACTUAL error on screen
                statusText.innerText = "Server Error: " + data.error;
                statusText.parentElement.style.opacity = '1';
                // Make it red so you know it failed
                statusText.style.color = "#ff4444"; 
                return; 
            }

            // SUCCESS
            const confidence = (data.confidence * 100).toFixed(0);
            statusText.style.color = "rgba(255, 255, 255, 0.8)"; // Reset color
            statusText.innerText = `You sound ${data.emotion} (${confidence}%)`;
            statusText.parentElement.style.opacity = '1';
            
            updatePlantVibe(data.emotion);
            setTimeout(() => closeIsland(), 4000);

        } catch (error) {
            console.error("Connection Failed:", error);
            statusText.innerText = "Connection Failed. Is Python running?";
            statusText.style.color = "#ff4444";
        }
    }

    // --- 6. VISUAL FEEDBACK (Plant Logic) ---
    function updatePlantVibe(emotion) {
        // Example: Find the glow element and change color
        const glow = document.querySelector('.bg-primary\\/20'); 
        const primary = document.querySelectorAll('.bg-primary');

        if (!glow) return;

        // Reset classes
        glow.className = "absolute bottom-20 left-1/2 -translate-x-1/2 w-48 h-48 blur-[60px] rounded-full -z-10 transition-colors duration-1000";

        if (emotion === 'angry') {
            glow.classList.add('bg-red-500/40');
        } else if (emotion === 'sad') {
            glow.classList.add('bg-blue-500/40');
        } else if (emotion === 'happy') {
            glow.classList.add('bg-yellow-400/40');
        } else {
            glow.classList.add('bg-primary/20'); // Default Green
        }
    }

    // --- EVENT LISTENERS ---
    btnRecord.addEventListener('click', startRecording);
    
    // The "Stop" button is the little square
    const btnStopInner = document.querySelector('#state-recording button:last-child'); 
    if(btnStopInner) btnStopInner.addEventListener('click', stopRecording);

    // Cancel button
    document.getElementById('btn-cancel').addEventListener('click', () => {
        if(mediaRecorder) mediaRecorder.stop(); // Stop mic
        audioChunks = []; // Clear data
        closeIsland(); // Reset UI
    });
    </script>
</body>

</html>